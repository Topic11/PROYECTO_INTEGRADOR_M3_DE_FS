name: DBT CI (Continuous Integration)

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  dbt-ci-checks:
    name: "Ejecutar y testear proyecto dbt"
    runs-on: ubuntu-latest

    steps:
      - name: "Clonar el cÃ³digo del repositorio"
        uses: actions/checkout@v3

      - name: "Autenticar con Google Cloud usando la Llave JSON"
        uses: "google-github-actions/auth@v2"
        with:
          credentials_json: "${{ secrets.GCP_SA_KEY }}"

      - name: "Instalar dbt y dependencias"
        run: pip install dbt-bigquery==1.7.9

      - name: "Configurar el perfil de dbt"
        run: |
          mkdir -p ~/.dbt
          echo "${{ secrets.DBT_PROFILES_YML }}" > ~/.dbt/profiles.yml

      - name: "Instalar paquetes de dbt (dbt_utils)"
        run: dbt deps --project-dir ./youtube_dbt_project

      - name: "Construir y testear todos los modelos de dbt"
        run: dbt build --full-refresh --project-dir ./youtube_dbt_project
